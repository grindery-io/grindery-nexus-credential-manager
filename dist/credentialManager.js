"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getAuthCredentialsDisplayInfo = getAuthCredentialsDisplayInfo;
exports.makeRequest = makeRequest;
exports.putAuthCredentials = putAuthCredentials;
exports.putConnectorSecrets = putConnectorSecrets;

var _jsonrpc = require("./jsonrpc");

var _db = require("./db");

function verifyDid(did) {
  if (typeof did !== "string" || !/^did:[^:]+:.+$/.test(did)) {
    throw new _jsonrpc.InvalidParamsError("Invalid DID");
  }
}

function verifyConnectorId(connectorId) {
  if (typeof connectorId !== "string" || !/^[a-zA-Z0-9-_]+$/.test(connectorId)) {
    throw new _jsonrpc.InvalidParamsError("Invalid connector ID");
  }
}

function verifyRequestSchema(request) {
  var _request$method;

  if (typeof request !== "object") {
    throw new _jsonrpc.InvalidParamsError("Invalid request schema");
  }

  if (request.method !== undefined && typeof request.method !== "string") {
    throw new _jsonrpc.InvalidParamsError("Invalid request method");
  }

  if (!request.url || typeof request.url !== "string") {
    throw new _jsonrpc.InvalidParamsError("Invalid request URL");
  }

  if (request.body !== undefined && typeof request.body !== "string" && typeof request.body !== "object") {
    throw new _jsonrpc.InvalidParamsError("Invalid request body");
  }

  if (request.params !== undefined && typeof request.params !== "object") {
    throw new _jsonrpc.InvalidParamsError("Invalid request params");
  }

  if (request.headers !== undefined && typeof request.headers !== "object") {
    throw new _jsonrpc.InvalidParamsError("Invalid request headers");
  }

  if (request.auth !== undefined && typeof request.auth !== "object") {
    throw new _jsonrpc.InvalidParamsError("Invalid request auth");
  }

  const method = ((_request$method = request.method) === null || _request$method === void 0 ? void 0 : _request$method.toString().toUpperCase()) ?? "GET";

  if (["GET", "HEAD"].includes(method) && request.body) {
    throw new _jsonrpc.InvalidParamsError("Invalid body for GET/HEAD request");
  }
}

async function putConnectorSecrets(connectorId, secrets) {
  verifyConnectorId(connectorId);

  if (typeof secrets !== "object") {
    throw new _jsonrpc.InvalidParamsError("Invalid secrets");
  }

  const collection = await (0, _db.getCollection)("connectorSecrets");
  await collection.replaceOne({
    connectorId
  }, {
    connectorId,
    secrets: JSON.stringify(secrets),
    updatedAt: Date.now()
  }, {
    upsert: true
  });
}

async function putAuthCredentials(connectorId, userDid, authCredentials, displayName) {
  verifyConnectorId(connectorId);
  verifyDid(userDid);

  if (typeof authCredentials !== "object") {
    throw new _jsonrpc.InvalidParamsError("Invalid auth credentials");
  }

  if ("url" in authCredentials) {
    verifyRequestSchema(authCredentials);
  }

  if (typeof displayName !== "string" || !displayName) {
    throw new _jsonrpc.InvalidParamsError("Invalid display name");
  }

  const collection = await (0, _db.getCollection)("authCredentials");
  const existingDoc = await collection.findOne({
    connectorId,
    userDid
  });
  const result = await collection.replaceOne({
    connectorId,
    userDid
  }, {
    connectorId,
    userDid,
    authCredentials: JSON.stringify(authCredentials),
    displayName,
    updatedAt: Date.now(),
    createdAt: (existingDoc === null || existingDoc === void 0 ? void 0 : existingDoc.createdAt) ?? Date.now()
  }, {
    upsert: true
  });
  return result.upsertedId.toString();
}

async function getAuthCredentialsDisplayInfo(connectorId, userDid) {
  verifyConnectorId(connectorId);
  verifyDid(userDid);
  const collection = await (0, _db.getCollection)("authCredentials");
  const docs = await collection.find({
    connectorId,
    userDid
  }).toArray();
  return docs.map(doc => {
    var _doc$displayName;

    return {
      id: doc._id.toString(),
      name: ((_doc$displayName = doc.displayName) === null || _doc$displayName === void 0 ? void 0 : _doc$displayName.toString()) || "<unknown>",
      createdAt: new Date(doc.createdAt).toISOString()
    };
  });
}

async function makeRequest(connectorId, userDid, request) {
  verifyConnectorId(connectorId);
  verifyDid(userDid);

  if (!request.url) {
    throw new _jsonrpc.InvalidParamsError("Invalid URL");
  }

  const collection = await (0, _db.getCollection)("authCredentials");
  const doc = await collection.findOne({
    connectorId,
    userDid
  });
  throw new Error("Not implemented");
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVkZW50aWFsTWFuYWdlci50cyJdLCJuYW1lcyI6WyJ2ZXJpZnlEaWQiLCJkaWQiLCJ0ZXN0IiwiSW52YWxpZFBhcmFtc0Vycm9yIiwidmVyaWZ5Q29ubmVjdG9ySWQiLCJjb25uZWN0b3JJZCIsInZlcmlmeVJlcXVlc3RTY2hlbWEiLCJyZXF1ZXN0IiwibWV0aG9kIiwidW5kZWZpbmVkIiwidXJsIiwiYm9keSIsInBhcmFtcyIsImhlYWRlcnMiLCJhdXRoIiwidG9TdHJpbmciLCJ0b1VwcGVyQ2FzZSIsImluY2x1ZGVzIiwicHV0Q29ubmVjdG9yU2VjcmV0cyIsInNlY3JldHMiLCJjb2xsZWN0aW9uIiwicmVwbGFjZU9uZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ1cGRhdGVkQXQiLCJEYXRlIiwibm93IiwidXBzZXJ0IiwicHV0QXV0aENyZWRlbnRpYWxzIiwidXNlckRpZCIsImF1dGhDcmVkZW50aWFscyIsImRpc3BsYXlOYW1lIiwiZXhpc3RpbmdEb2MiLCJmaW5kT25lIiwicmVzdWx0IiwiY3JlYXRlZEF0IiwidXBzZXJ0ZWRJZCIsImdldEF1dGhDcmVkZW50aWFsc0Rpc3BsYXlJbmZvIiwiZG9jcyIsImZpbmQiLCJ0b0FycmF5IiwibWFwIiwiZG9jIiwiaWQiLCJfaWQiLCJuYW1lIiwidG9JU09TdHJpbmciLCJtYWtlUmVxdWVzdCIsIkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7O0FBRUE7O0FBRUEsU0FBU0EsU0FBVCxDQUFtQkMsR0FBbkIsRUFBZ0M7QUFDOUIsTUFBSSxPQUFPQSxHQUFQLEtBQWUsUUFBZixJQUEyQixDQUFDLGlCQUFpQkMsSUFBakIsQ0FBc0JELEdBQXRCLENBQWhDLEVBQTREO0FBQzFELFVBQU0sSUFBSUUsMkJBQUosQ0FBdUIsYUFBdkIsQ0FBTjtBQUNEO0FBQ0Y7O0FBQ0QsU0FBU0MsaUJBQVQsQ0FBMkJDLFdBQTNCLEVBQWdEO0FBQzlDLE1BQUksT0FBT0EsV0FBUCxLQUF1QixRQUF2QixJ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YSxPQUFYLENBQW1CO0FBQUU1QixJQUFBQSxXQUFGO0FBQWV3QixJQUFBQTtBQUFmLEdBQW5CLENBQWxCO0FBQ0EsUUFBTSxJQUFJbUIsS0FBSixDQUFVLGlCQUFWLENBQU47QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEludmFsaWRQYXJhbXNFcnJvciB9IGZyb20gXCIuL2pzb25ycGNcIjtcbmltcG9ydCB7IFJlcXVlc3RTY2hlbWEsIEF1dGhDcmVkZW50aWFsc0Rpc3BsYXlJbmZvLCBNYWtlUmVxdWVzdFJlc3BvbnNlIH0gZnJvbSBcIi4vdHlwZXNcIjtcbmltcG9ydCB7IGdldENvbGxlY3Rpb24gfSBmcm9tIFwiLi9kYlwiO1xuXG5mdW5jdGlvbiB2ZXJpZnlEaWQoZGlkOiBzdHJpbmcpIHtcbiAgaWYgKHR5cGVvZiBkaWQgIT09IFwic3RyaW5nXCIgfHwgIS9eZGlkOlteOl0rOi4rJC8udGVzdChkaWQpKSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRQYXJhbXNFcnJvcihcIkludmFsaWQgRElEXCIpO1xuICB9XG59XG5mdW5jdGlvbiB2ZXJpZnlDb25uZWN0b3JJZChjb25uZWN0b3JJZDogc3RyaW5nKSB7XG4gIGlmICh0eXBlb2YgY29ubmVjdG9ySWQgIT09IFwic3RyaW5nXCIgfHwgIS9eW2EtekEtWjAtOS1fXSskLy50ZXN0KGNvbm5lY3RvcklkKSkge1xuICAgIHRocm93IG5ldyBJbnZhbGlkUGFyYW1zRXJyb3IoXCJJbnZhbGlkIGNvbm5lY3RvciBJRFwiKTtcbiAgfVxufVxuZnVuY3Rpb24gdmVyaWZ5UmVxdWVzdFNjaGVtYShyZXF1ZXN0OiBSZXF1ZXN0U2NoZW1hKSB7XG4gIGlmICh0eXBlb2YgcmVxdWVzdCAhPT0gXCJvYmplY3RcIikge1xuICAgIHRocm93IG5ldyBJbnZhbGlkUGFyYW1zRXJyb3IoXCJJbnZhbGlkIHJlcXVlc3Qgc2NoZW1hXCIpO1xuICB9XG4gIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiByZXF1ZXN0Lm1ldGhvZCAhPT0gXCJzdHJpbmdcIikge1xuICAgIHRocm93IG5ldyBJbnZhbGlkUGFyYW1zRXJyb3IoXCJJbnZhbGlkIHJlcXVlc3QgbWV0aG9kXCIpO1xuICB9XG4gIGlmICghcmVxdWVzdC51cmwgfHwgdHlwZW9mIHJlcXVlc3QudXJsICE9PSBcInN0cmluZ1wiKSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRQYXJhbXNFcnJvcihcIkludmFsaWQgcmVxdWVzdCBVUkxcIik7XG4gIH1cbiAgaWYgKHJlcXVlc3QuYm9keSAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiByZXF1ZXN0LmJvZHkgIT09IFwic3RyaW5nXCIgJiYgdHlwZW9mIHJlcXVlc3QuYm9keSAhPT0gXCJvYmplY3RcIikge1xuICAgIHRocm93IG5ldyBJbnZhbGlkUGFyYW1zRXJyb3IoXCJJbnZhbGlkIHJlcXVlc3QgYm9keVwiKTtcbiAgfVxuICBpZiAocmVxdWVzdC5wYXJhbXMgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgcmVxdWVzdC5wYXJhbXMgIT09IFwib2JqZWN0XCIpIHtcbiAgICB0aHJvdyBuZXcgSW52YWxpZFBhcmFtc0Vycm9yKFwiSW52YWxpZCByZXF1ZXN0IHBhcmFtc1wiKTtcbiAgfVxuICBpZiAocmVxdWVzdC5oZWFkZXJzICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHJlcXVlc3QuaGVhZGVycyAhPT0gXCJvYmplY3RcIikge1xuICAgIHRocm93IG5ldyBJbnZhbGlkUGFyYW1zRXJyb3IoXCJJbnZhbGlkIHJlcXVlc3QgaGVhZGVyc1wiKTtcbiAgfVxuICBpZiAocmVxdWVzdC5hdXRoICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHJlcXVlc3QuYXV0aCAhPT0gXCJvYmplY3RcIikge1xuICAgIHRocm93IG5ldyBJbnZhbGlkUGFyYW1zRXJyb3IoXCJJbnZhbGlkIHJlcXVlc3QgYXV0aFwiKTtcbiAgfVxuXG4gIGNvbnN0IG1ldGhvZCA9IHJlcXVlc3QubWV0aG9kPy50b1N0cmluZygpLnRvVXBwZXJDYXNlKCkgPz8gXCJHRVRcIjtcbiAgaWYgKFtcIkdFVFwiLCBcIkhFQURcIl0uaW5jbHVkZXMobWV0aG9kKSAmJiByZXF1ZXN0LmJvZHkpIHtcbiAgICB0aHJvdyBuZXcgSW52YWxpZFBhcmFtc0Vycm9yKFwiSW52YWxpZCBib2R5IGZvciBHRVQvSEVBRCByZXF1ZXN0XCIpO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwdXRDb25uZWN0b3JTZWNyZXRzKGNvbm5lY3RvcklkOiBzdHJpbmcsIHNlY3JldHM6IHsgW2tleTogc3RyaW5nXTogdW5rbm93biB9KSB7XG4gIHZlcmlmeUNvbm5lY3RvcklkKGNvbm5lY3RvcklkKTtcbiAgaWYgKHR5cGVvZiBzZWNyZXRzICE9PSBcIm9iamVjdFwiKSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRQYXJhbXNFcnJvcihcIkludmFsaWQgc2VjcmV0c1wiKTtcbiAgfVxuICBjb25zdCBjb2xsZWN0aW9uID0gYXdhaXQgZ2V0Q29sbGVjdGlvbihcImNvbm5lY3RvclNlY3JldHNcIik7XG4gIGF3YWl0IGNvbGxlY3Rpb24ucmVwbGFjZU9uZShcbiAgICB7IGNvbm5lY3RvcklkIH0sXG4gICAgeyBjb25uZWN0b3JJZCwgc2VjcmV0czogSlNPTi5zdHJpbmdpZnkoc2VjcmV0cyksIHVwZGF0ZWRBdDogRGF0ZS5ub3coKSB9LFxuICAgIHsgdXBzZXJ0OiB0cnVlIH1cbiAgKTtcbn1cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwdXRBdXRoQ3JlZGVudGlhbHMoXG4gIGNvbm5lY3RvcklkOiBzdHJpbmcsXG4gIHVzZXJEaWQ6IHN0cmluZyxcbiAgYXV0aENyZWRlbnRpYWxzOiBSZXF1ZXN0U2NoZW1hIHwgb2JqZWN0LFxuICBkaXNwbGF5TmFtZTogc3RyaW5nXG4pIHtcbiAgdmVyaWZ5Q29ubmVjdG9ySWQoY29ubmVjdG9ySWQpO1xuICB2ZXJpZnlEaWQodXNlckRpZCk7XG4gIGlmICh0eXBlb2YgYXV0aENyZWRlbnRpYWxzICE9PSBcIm9iamVjdFwiKSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRQYXJhbXNFcnJvcihcIkludmFsaWQgYXV0aCBjcmVkZW50aWFsc1wiKTtcbiAgfVxuICBpZiAoXCJ1cmxcIiBpbiBhdXRoQ3JlZGVudGlhbHMpIHtcbiAgICB2ZXJpZnlSZXF1ZXN0U2NoZW1hKGF1dGhDcmVkZW50aWFscyBhcyBSZXF1ZXN0U2NoZW1hKTtcbiAgfVxuICBpZiAodHlwZW9mIGRpc3BsYXlOYW1lICE9PSBcInN0cmluZ1wiIHx8ICFkaXNwbGF5TmFtZSkge1xuICAgIHRocm93IG5ldyBJbnZhbGlkUGFyYW1zRXJyb3IoXCJJbnZhbGlkIGRpc3BsYXkgbmFtZVwiKTtcbiAgfVxuICBjb25zdCBjb2xsZWN0aW9uID0gYXdhaXQgZ2V0Q29sbGVjdGlvbihcImF1dGhDcmVkZW50aWFsc1wiKTtcbiAgY29uc3QgZXhpc3RpbmdEb2MgPSBhd2FpdCBjb2xsZWN0aW9uLmZpbmRPbmUoeyBjb25uZWN0b3JJZCwgdXNlckRpZCB9KTtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29sbGVjdGlvbi5yZXBsYWNlT25lKFxuICAgIHsgY29ubmVjdG9ySWQsIHVzZXJEaWQgfSxcbiAgICB7XG4gICAgICBjb25uZWN0b3JJZCxcbiAgICAgIHVzZXJEaWQsXG4gICAgICBhdXRoQ3JlZGVudGlhbHM6IEpTT04uc3RyaW5naWZ5KGF1dGhDcmVkZW50aWFscyksXG4gICAgICBkaXNwbGF5TmFtZSxcbiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgIGNyZWF0ZWRBdDogZXhpc3RpbmdEb2M/LmNyZWF0ZWRBdCA/PyBEYXRlLm5vdygpLFxuICAgIH0sXG4gICAgeyB1cHNlcnQ6IHRydWUgfVxuICApO1xuICByZXR1cm4gcmVzdWx0LnVwc2VydGVkSWQudG9TdHJpbmcoKTtcbn1cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBdXRoQ3JlZGVudGlhbHNEaXNwbGF5SW5mbyhcbiAgY29ubmVjdG9ySWQ6IHN0cmluZyxcbiAgdXNlckRpZDogc3RyaW5nXG4pOiBQcm9taXNlPEF1dGhDcmVkZW50aWFsc0Rpc3BsYXlJbmZvW10+IHtcbiAgdmVyaWZ5Q29ubmVjdG9ySWQoY29ubmVjdG9ySWQpO1xuICB2ZXJpZnlEaWQodXNlckRpZCk7XG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBhd2FpdCBnZXRDb2xsZWN0aW9uKFwiYXV0aENyZWRlbnRpYWxzXCIpO1xuICBjb25zdCBkb2NzID0gYXdhaXQgY29sbGVjdGlvbi5maW5kKHsgY29ubmVjdG9ySWQsIHVzZXJEaWQgfSkudG9BcnJheSgpO1xuICByZXR1cm4gZG9jcy5tYXAoKGRvYykgPT4gKHtcbiAgICBpZDogZG9jLl9pZC50b1N0cmluZygpLFxuICAgIG5hbWU6IGRvYy5kaXNwbGF5TmFtZT8udG9TdHJpbmcoKSB8fCBcIjx1bmtub3duPlwiLFxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoZG9jLmNyZWF0ZWRBdCkudG9JU09TdHJpbmcoKSxcbiAgfSkpO1xufVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1ha2VSZXF1ZXN0KFxuICBjb25uZWN0b3JJZDogc3RyaW5nLFxuICB1c2VyRGlkOiBzdHJpbmcsXG4gIHJlcXVlc3Q6IFJlcXVlc3RTY2hlbWFcbik6IFByb21pc2U8TWFrZVJlcXVlc3RSZXNwb25zZT4ge1xuICB2ZXJpZnlDb25uZWN0b3JJZChjb25uZWN0b3JJZCk7XG4gIHZlcmlmeURpZCh1c2VyRGlkKTtcbiAgaWYgKCFyZXF1ZXN0LnVybCkge1xuICAgIHRocm93IG5ldyBJbnZhbGlkUGFyYW1zRXJyb3IoXCJJbnZhbGlkIFVSTFwiKTtcbiAgfVxuICBjb25zdCBjb2xsZWN0aW9uID0gYXdhaXQgZ2V0Q29sbGVjdGlvbihcImF1dGhDcmVkZW50aWFsc1wiKTtcbiAgY29uc3QgZG9jID0gYXdhaXQgY29sbGVjdGlvbi5maW5kT25lKHsgY29ubmVjdG9ySWQsIHVzZXJEaWQgfSk7XG4gIHRocm93IG5ldyBFcnJvcihcIk5vdCBpbXBsZW1lbnRlZFwiKTtcbn1cbiJdfQ==